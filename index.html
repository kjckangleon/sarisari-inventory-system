<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Item List Manager</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>📦 Item List Manager</h1>

      <!-- Manual Input -->
      <section>
        <h2>➕ Add Item</h2>
        <form id="manual-form">
          <input type="text" id="manual-name" placeholder="Item Name" required />
          <input type="number" id="manual-price" placeholder="Price" required />
          <input type="number" id="manual-stock" placeholder="Stock" required />
          <input type="text" id="manual-code" placeholder="Barcode (optional)" />
          <input type="file" id="manual-image" accept="image/*" />
          <button type="submit">Add Item</button>
        </form>
      </section>

      <!-- Barcode Input with Camera -->
      <section>
        <h2>📷 Scan Barcode with Camera</h2>
        <button id="start-scan">Start Camera Scan</button>
        <video id="barcode-scanner" class="hidden" autoplay muted playsinline></video>
        <p id="scan-status"></p>
      </section>

      <!-- Find by Barcode -->
      <section>
        <h2>🔍 Find Item by Barcode</h2>
        <input type="text" id="search-barcode" placeholder="Enter or scan barcode" />
        <div id="search-result"></div>
      </section>

      <!-- Item List -->
      <section>
        <h2>📋 Item List</h2>
        <ul id="items-ul"></ul>
      </section>
    </div>

    <script>
      const itemList = document.getElementById('items-ul');
      const searchInput = document.getElementById('search-barcode');
      const searchResult = document.getElementById('search-result');
      const startScanBtn = document.getElementById('start-scan');
      const videoElement = document.getElementById('barcode-scanner');
      const scanStatus = document.getElementById('scan-status');
      let items = JSON.parse(localStorage.getItem('items')) || [];
      let codeReader;

      function saveItems() {
        localStorage.setItem('items', JSON.stringify(items));
      }

      function renderItems() {
        itemList.innerHTML = '';
        items.forEach((item, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            ${item.image ? `<img src="${item.image}" alt="${item.name}" />` : ''}
            <div class="item-info">
              <h3>${item.name}</h3>
              <p>Price: ₱${item.price}</p>
              <p>Stock: ${item.stock}</p>
              <p>Barcode: ${item.barcode || 'N/A'}</p>
            </div>
            <button class="edit-btn" onclick="editItem(${index})">Edit</button>
            <button class="delete-btn" onclick="deleteItem(${index})">Delete</button>
          `;
          itemList.appendChild(li);
        });
      }

      window.deleteItem = function(index) {
        if (confirm('Are you sure you want to delete this item?')) {
          items.splice(index, 1);
          saveItems();
          renderItems();
        }
      };

      window.editItem = function(index) {
        const item = items[index];
        const name = prompt('Edit Name:', item.name);
        const price = prompt('Edit Price:', item.price);
        const stock = prompt('Edit Stock:', item.stock);
        const barcode = prompt('Edit Barcode:', item.barcode);
        if (name && price && stock) {
          items[index] = { ...item, name, price: parseFloat(price), stock: parseInt(stock), barcode };
          saveItems();
          renderItems();
        }
      };

      document.getElementById('manual-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('manual-name').value.trim();
        const price = parseFloat(document.getElementById('manual-price').value);
        const stock = parseInt(document.getElementById('manual-stock').value);
        const barcode = document.getElementById('manual-code').value.trim();
        const imageFile = document.getElementById('manual-image').files[0];
        let imageUrl = '';

        if (imageFile) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            imageUrl = evt.target.result;
            addItem({ name, price, stock, barcode, image: imageUrl });
          };
          reader.readAsDataURL(imageFile);
        } else {
          addItem({ name, price, stock, barcode, image: '' });
        }

        e.target.reset();
      });

      function addItem(item) {
        items.push(item);
        saveItems();
        renderItems();
      }

      async function startCameraScan() {
        scanStatus.textContent = 'Requesting camera access...';
        videoElement.classList.remove('hidden');
      
        try {
          await navigator.mediaDevices.getUserMedia({ video: true });
      
          const reader = new ZXing.BrowserMultiFormatReader();
          const devices = await reader.getVideoInputDevices();
          const backCamera = devices.find(device => device.label.toLowerCase().includes('back')) || devices[0];
      
          if (!backCamera) throw new Error('No video input devices found');
      
          codeReader = reader;
          await codeReader.decodeFromVideoDevice(backCamera.deviceId, videoElement, (result, err) => {
            if (result) {
              const scanned = result.getText();
              scanStatus.textContent = `Scanned barcode: ${scanned}`;
              const found = items.find(i => i.barcode === scanned);
              if (!found) {
                const name = prompt('Item name for scanned barcode:');
                const price = prompt('Price:');
                const stock = prompt('Stock:');
                if (name && price && stock) {
                  addItem({ name, price: parseFloat(price), stock: parseInt(stock), barcode: scanned, image: '' });
                }
              } else {
                alert(`Already exists: ${found.name}`);
              }
            }
          });
      
          scanStatus.textContent = 'Scanning...';
      
        } catch (err) {
          scanStatus.textContent = `❌ Camera access error: ${err.message}`;
          console.error('Camera access error:', err);
        }
      }


      searchInput.addEventListener('input', function() {
        const query = searchInput.value.trim();
        if (query === '') {
          searchResult.innerHTML = '';
          return;
        }
        const item = items.find(i => i.barcode === query);
        if (item) {
          searchResult.innerHTML = `
            <div class="p-4 border rounded bg-green-50">
              <h3>${item.name}</h3>
              <p>Price: ₱${item.price}</p>
              <p>Stock: ${item.stock}</p>
              <p>Barcode: ${item.barcode}</p>
              ${item.image ? `<img src="${item.image}" alt="${item.name}" />` : ''}
            </div>
          `;
        } else {
          searchResult.innerHTML = '<p style="color: red;">Item not found.</p>';
        }
      });

      startScanBtn.addEventListener('click', startCameraScan);
      renderItems();
    </script>
  </body>
</html>
